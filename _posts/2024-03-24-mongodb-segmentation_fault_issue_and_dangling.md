---
layout: post
title: MongoDB - Segmentation Fault error 와 Dangling
subtitle: dangling, segmentation fault 뜻과 관계
categories: Tech
tags: [mongodb]
---

## 0. 배경

- MongoDB가 간헐적으로 Down되는 현상이 발견되었다. Error Log 내용은 `segmentation fault` 였다.
- MongoDB developer community에서는 MongoDB 의 버그라는 의견이 있었고 업데이트하면 해결이 될까? 하는 확신도 없다.
- MongoDB가 죽는 시간대를 봤을때, 의심되는 관련 작업은 대규모 데이터 삭제였다. 2TB가 넘는 데이터를 며칠에 걸쳐 삭제 중이었고, 특정단위로 쪼개어 sleep을 주고 실행중이었으나, 삭제작업을 새벽시간에 마무리할때 쯤에 Down 현상이 발생했다.
- 해서 Dangling이 이 버그를 유발했을까 하는 의심이 내부적으로 있었고, Dangling과 Segmentation Fault의 관계에 대해서 정리해봤다.
- 결론은.. 확신은 할수 없으나.. 데이터를 좀더 쪼개서 sleep도 넉넉히 줘야하거나 업데이트를 통해 해결되기를 바라는 수밖에.

## 1. 의미

### Dangling

컴퓨팅에서 "dangling"은 보통 참조(포인터나 링크와 같은)가 삭제되거나 이동된 자원(메모리나 데이터와 같은)을 가리키고 있지만 그 자원이 더 이상 존재하지 않는 상황을 의미한다. 예를 들어, 좋아하는 웹사이트의 북마크를 가지고 있는데, 그 웹사이트의 주소가 변경되었다고 상상해보자. 오래된 북마크를 사용하려고 하면, 내가 좋아하는 웹사이트로 접속할 수 없다. 왜냐하면 이제 "dangling" 상태이기 때문이다. — 더 이상 존재하지 않는 위치를 가리킨다. MongoDB와 같은 데이터베이스에서, 데이터가 삭제되었지만 그 데이터를 가리키는 참조(인덱스와 같은)가 제대로 업데이트되지 않을 때 "dangling" 참조가 발생할 수 있으며, 데이터베이스가 이제 존재하지 않는 데이터에 접근하려고 할 때 일관성 없거나 오류가 발생할 수 있다..

### Segmentation Fault

Segmentation Fault는 컴퓨터 프로그램에서 발생하는 오류이다. 프로그램이 접근하려는 메모리 부분에 대한 접근이 허용되지 않을 때 발생한다. 이는 위치가 운영 체제에 의해 자체적으로 예약되었거나, 프로그램이 할당되지 않은 메모리를 읽거나 쓰려고 시도하기 때문이다. 이는 잠겨 있거나 존재하지 않는 방에 들어가려고 하는 것과 같으며, 시도할 경우 막히게 된다. 프로그래밍의 맥락에서, 이 막힘은 프로그램이 충돌하는 것으로, 운영 체제가 잠재적으로 해로운 행위를 하는 것을 방지한다.

이 두 가지 문제는 모두 참조와 메모리의 관리 및 무결성과 관련이 있습니다. dangling 참조는 부정확하거나 비효율적인 작업으로 이어질 수 있으며, segmentation fault는 더 심각하게, 프로그램이 메모리 영역에 부적절하게 접근할 때 프로그램이 충돌하게 만듭니다.

## 2. Dangling 과 Segmentation Fault 의 관계

Dangling 참조와 Segmentation Fault는 서로 관련이 있지만, 그들이 프로그램이나 시스템에 미치는 영향과 나타나는 방식에서 차이가 있다:

**Dangling reference**는 참조(프로그래밍에서의 포인터나 데이터베이스에서의 인덱스 같은)가 이동되었거나 삭제되었거나 다른 방식으로 사용 불가능하게 된 자원을 가리키는 시나리오를 말한다. Dangling reference는 잘못된 프로그램 동작, 오류, 또는 비효율성을 포함한 다양한 문제로 이어질 수 있다. 그러나 그 자체로는 반드시 프로그램이 충돌하게 하지는 않는다. 구체적인 결과는 프로그램이나 시스템이 이러한 참조를 사용할 때 어떻게 처리하는지에 달려 있다.

**Segmentation Fault**는 보통 운영 체제의 메모리 관리 내에서 발생하는 더 낮은 수준의 오류이다. Segmentation Fault는 프로그램이 접근 권한이 없거나 존재하지 않는 메모리 세그먼트에 접근하려고 시도할 때 발생한다. 이는 Dangling 보다 더 심각한 문제로, 메모리를 손상시키거나 다른 프로그램의 오작동을 초래할 수 있는 불법 작업을 수행하는 것을 방지하기 위해 프로그램을 즉시 종료(충돌)시킨다.

**Dangling과 Segmentation Fault 사이의 관계** 
다른 문제임에도 불구하고, Dangling Reference는 Segmentation Fault로 이어질 수 있다. 예를 들어, 프로그램이 해제되었거나 재할당된 메모리 조각에 대한 Dangling 포인터(참조의 한 유형)를 가지고 있고, 그 프로그램이 그 메모리 위치에 읽거나 쓰려고 시도할 경우, 이는 Segmentation Fault를 유발할 수 있다. 운영 체제는 불법 접근 시도를 감지하고 시스템의 무결성을 보호하기 위해 프로그램을 종료한다.

요약하자면, 모든 Dangling Reference가 Segmentation Fault로 이어지는 것은 아니지만, 프로그램이 이러한 참조를 잘못 사용하여 메모리에 접근하려고 시도할 때 잠재적 원인이 될 수 있다.

## 3. Segmentation Fault 오류가 Dangling이 원인이었을 수 있을까?

Dangling reference가 관련된 시나리오, 예를 들어 인덱스를 삭제함으로써 생성된 경우, Segmentation Fault로 이어질 수 있지만, 소프트웨어와 기반 시스템의 특정 조건과 의해 결정된다.

MongoDB와 같은 데이터베이스의 맥락에서 이 과정은 다음과 같이 전개된다고 가정할 수 있다:

**데이터 및 그 인덱스 삭제:** 데이터베이스에서 데이터가 삭제될 때, 그 데이터를 가리키는 모든 인덱스도 업데이트되거나 삭제되어야 한다. 이 과정이 제대로 처리되지 않으면, 더 이상 존재하지 않는 데이터를 가리키는 Dangling reference인 인덱스가 남을 수 있다.

**Dangling Reference 접근:** 데이터베이스나 애플리케이션이 이러한 Dangling reference에 접근하려고 하면, 데이터가 없는 곳에서 데이터를 찾으려고 한다. high-level operation들, 예를 들어 데이터베이스에서의 작업들은 이러한 불일치를 잘 처리하도록 설계되어 있어, 오류를 던지거나 누락된 데이터를 무시한다.

**Segmentation 유발:** Segmentation Fault가 Dangling reference의 직접적 결과로 발생하려면, 존재하지 않는 데이터에 접근하는 시도가 운영 체제에 의해 부과된 메모리 접근 규칙을 위반해야 한다. MongoDB와 같은 사용자 공간 애플리케이션에 의해 관리되는 데이터베이스의 맥락에서, 이는 이례적인 일다. Segmentation Fault는 일반적으로 프로그램 코드의 버그로 인해 발생하며, Dangling reference 의 단순한 존재로 인해 발생하지는 않는다.

잘 설계된 데이터베이스 시스템에서, 댕글링 참조에 접근하는 것은 세그멘테이션 폴트를 유발할 수 있는 제한되지 않은 메모리 접근이 아니라 오류 처리 루틴으로 이어져야 한다. 세그멘테이션 폴트가 발생하려면, 소프트웨어가 접근 권한이 없는 메모리를 읽거나 쓰려고 시도해야 한다. 이는 삭제된 데이터가 차지하던 메모리 위치가 다른 용도로 재할당되거나 운영 체제에 반환되었고, 데이터베이스 소프트웨어가 적절한 검사 없이 그것에 접근하려고 잘못 시도한 경우에 발생할 수 있다.
